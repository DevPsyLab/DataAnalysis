---
title: "Multiple Imputation"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      error = TRUE,
                      comment = "",
                      class.source = "fold-show")
```

# Approaches to Multiple Imputation

- multiple imputation by joint modeling
    - assumes that the variables in follow a joint distribution, e.g.:
        - multivariate normal (i.e., multivariate normal imputation)
    - R packages:
        - `jomo`
        - `pan`
        - `Amelia`
- multiple imputation by chained equations
    - aka:
        - fully conditional specification multiple imputation
        - sequential regression multiple imputation
    - R packages:
        - `mice`
            - predictive mean matching (`?mice::mice.impute.pmm`) can be useful to obtain bounded imputations for non-normally distributed variables

# Multilevel Multiple Imputation

## Three-Level and Cross-Classified Data

https://simongrund1.github.io/posts/multiple-imputation-for-three-level-and-cross-classified-data/

## Methods

### `mice`

#### Continuous Outcomes

https://stefvanbuuren.name/fimd/sec-multioutcome.html#methods

```{r, eval = FALSE}
?mice::mice.impute.2l.norm
?mice::mice.impute.2l.pan
?mice::mice.impute.2l.lmer
?miceadds::mice.impute.2l.pmm
?miceadds::mice.impute.2l.contextual.pmm
?miceadds::mice.impute.2l.continuous
?micemd::mice.impute.2l.2stage.norm
?micemd::mice.impute.2l.2stage.pmm
?micemd::mice.impute.2l.glm.norm
?micemd::mice.impute.2l.jomo
```

#### Discrete Outcomes

https://stefvanbuuren.name/fimd/sec-catoutcome.html#methods-1

```{r, eval = FALSE}
?mice::mice.impute.2l.bin
?miceadds::mice.impute.2l.binary
?micemd::mice.impute.2l.2stage.bin
?micemd::mice.impute.2l.glm.bin
```

#### Specifying the Predictor Matrix

- cluster variable: `-2`
- fixed effect of predictor: `1`
- fixed effect and random effect of predictor: `2`
- include cluster mean of predictor in addition to fixed effect of predictor: `3`
- include cluster mean of predictor in addition to fixed effect and random effect of predictor: `4`

### `jomo`

```{r, eval = FALSE}
level1Vars <- c("v1","v2")
level2Vars <- c("v3","v4")
clusterVars <- c("id")
fullyObservedCovariates <- c("age","sex")

set.seed(52242)

mi_jomo <- jomo(
  Y = data.frame(dataToImpute[,level1Vars]),
  Y2 = data.frame(dataToImpute[,level2Vars]),
  X = data.frame(dataToImpute[,fullyObservedCovariates]),
  clus = data.frame(dataToImpute[,clusterVars]),
  nimp = 100,
  meth = "random"
)
```

### `Amelia`

- `!` in the console output indicates that the current estimated complete data covariance matrix is not invertible
- `*` in the console output indicates that the likelihood has not monotonically increased in that step

```{r, eval = FALSE}
set.seed(52242)

mi_amelia <- amelia(
  dataToImpute,
  m = 100,
  ts = "age",
  cs = "id",
  polytime = 1,
  intercs = TRUE,
  ords = ordinalVars,
  bounds = varBounds,
  parallel = "snow",
  ncpus = numCores,
  empri = .01*nrow(dataToImpute)) # ridge prior for numerical stability
```

# Parallel Processing

https://www.gerkovink.com/miceVignettes/futuremice/Vignette_futuremice.html

```{r, eval = FALSE}
numCores <- parallelly::availableCores(logical = TRUE) - 1

mi_parallel_mice <- futuremice(
  dataToImpute,
  method = meth,
  predictorMatrix = pred,
  m = 100,
  maxit = 100,
  parallelseed = 52242,
  n.core = numCores)
```

# Imputation Diagnostics

## Trace Plots

On convergence, the streams of the trace plots should intermingle and be free of any trend (at the later iterations).
Convergence is diagnosed when the variance between different sequences is no larger than the variance within each individual sequence.

- https://stefvanbuuren.name/fimd/sec-algoptions.html

```{r, eval = FALSE}
plot(mice_object, c("variable"))
```

## Density Plots

```{r, eval = FALSE}
densityplot(mice_object)
densityplot(mice_object, ~ variable)
```

## Strip Plots

```{r, eval = FALSE}
stripplot(mice_object)
stripplot(mice_object, variable ~ .imp)
```

# Resources

https://stefvanbuuren.name/fimd

https://www.gerkovink.com/miceVignettes/Multi_level/Multi_level_data.html
